<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
 <title>Stonk‚Ñ¢BotPortal</title>
 <link rel="stylesheet" href="index.css" type="text/css" media="screen" title="Shrewm"/>
</head><body>

<h1 class="header">
  <!-- img class="headerimage" src="thumbmoney.jpg"/ -->
  <canvas id="stonkgraph" width="50%" height="40%" style="border:0; margin:0; padding:0"></canvas>
  Stonk‚Ñ¢BotPortalWorld<i> 0.0.7ùõº</i>
  <input id="login" class="login" name="login" type="search" placeholder="login" onkeydown="login(event)"/>
</h1>

<table border="1" class="yololians">
<tr><td>
  <b>YOLOLIANS</b>
</td></tr><tr><td>
  <pre id="yololians"></pre>
</td></tr></table>

<table border="1" class="yololians">
<tr><td>
  <b id="username">User</b>
</td></tr><tr><td>
  <pre id="stats"></pre>
</td></tr></table>

<table border="1" class="mainbody">
<tr><td>
  <h2>Welcome To ‚Ñ¢Bot's Web Portal</h2>
<hr/>
  <p>
    For now, all trading is currently supported in Telegram only.
  </p>
</td></tr>
</table>

<p class="counter">000001</p>

<div id="cookies" class="cookies" onmousedown="ElementById('cookies').style.display='none'">
  <p>This site uses COOKIES thus will TRACK and SELL every and all of your PRIVATE PERSONAL INFORMATION any chance it gets to the full extent of the law and free capitalism.</p>
  <p><i>I agree to these terms</i></p>
  <i style="font-size:xx-small">(Don't hate the browser, hate the game.)</i>
</div>

<p id="xDB"></p>
<script type="text/javascript">//<![CDATA[
"use strict"


/******************************************************************************
  Useful aliases and objects
******************************************************************************/
var PI  = Math.PI;
var PI2  = PI*2;
var Floor = Math.floor;
var Round = Math.round;
var Ceil  = Math.ceil;
var Pow   = Math.pow;
var Abs   = Math.abs;
var Rnd   = Math.random;
var Cos   = Math.cos;
var Sin   = Math.sin;
var Mod   = function (n,d) { return n - d * Math.floor(n/d); }
var CreateAppendChild = function (name, element) { return element.appendChild(document.createElement(name)); }
var CreateInsertBefore = function (name, element) { return element.insertBefore(document.createElement(name), element.firstChild); }
var ToggleElementDisplay = function (e1, e2) {
  var off = e1.style.display == "none"; // 'none' implies not displayed.  '' implies the default CSS value.
  e1.style.display = off ? "" : "none"; // Toggle e1's display state.
  if (e2) { e2.style.display = off ? "none" : ""; } // e2's style is opposite e1.
}
var ElementById = function(id) { return document.getElementById(id); }

/******************************************************************************
  Debug message console and error checking

  DOM requirements::
    <p id="DB"></p>        -- If nonexistent, the DB object will revert to using the browser's console.

  Usage::
    DB("string")           -- Send string to info window.  Behaves like a pre element.
    DB.log("string")       -- Send string to console.log.
    DB.post(type, string)  -- Send string to info window band keeps track of type.  Subsequent typed messages replace the last.
    DB.post(type, string)  -- Send string to info window band keeps track of type.  Subsequent typed messages replace the last.
    DB.clear()             -- Empty the entire DB element.
    DB.check(expr, string) -- If expr is false, send string to console.  status() will then always return false.
    DB.status()            -- Returns false if check ever failed.
******************************************************************************/
var DB = (function () {
  var consoleElement = document.getElementById('DB');
  var self;
  var status = true;
  var shouldNewline = true; // Want to prepend a newline when the last message was plain text.
  var lastPostType = false, lastPost = false;
  var repeatCount = 0;

  var setStyles = function (e) {
    return;
    e.style.border = "solid 1px green";
    e.style.whiteSpace = "pre";
    e.style.overflow = "auto";
    e.style.maxHeight = "20em";
  }

  // Create the instance which is a function.  Also create the clear function.
  if (!consoleElement) {
    self = function (s) { console.log(s); lastPostType = false;}
    self.log = self;
    self.post  = function (t, s) { // For the console, only the first post type is displayed.
      if (t != lastPostType) {
        console.log("[" + t + "]" + s);
        lastPostType = t;
      }
    }
    self.clear = function () { lastPostType = false; }
  } else {
    setStyles(consoleElement);
    self = function (s) {
      if (lastPost == s) { 
       ++repeatCount;
        s = repeatCount + s;
      } else {
        repeatCount = 0; 
      }
      consoleElement.innerHTML += (shouldNewline ? "" : "\n") + s;
      consoleElement.scrollTop = consoleElement.scrollHeight;
      shouldNewline = lastPostType = false;
    }
    self.log = function (s) { console.log(s); }
    self.post = function (t, s) {
      if (t == lastPostType) {
        if (lastPost == s) { ++repeatCount; }
        consoleElement.lastChild.innerText = (0<repeatCount ? repeatCount : "") + "[" + t + "]" + s;
      } else {
        consoleElement.appendChild(document.createElement('p')).innerText = "[" + t + "]" + s; 
        consoleElement.scrollTop = consoleElement.scrollHeight;
        lastPostType = t;
        repeatCount = 0;
      }
      lastPost = s;
      shouldNewline = true;
    }
    self.clear = function () {
       consoleElement.innerHTML = "";
      shouldNewline = lastPostType = true;
    }
  }

  self.check = function (expr, msg) {
    status = status && expr;
    return expr || self(msg) && false;
  }

  self.status = function () { return status; }

  return self;
})(); // DB


/******************************************************************************
  Hyphen - Websocket
******************************************************************************/
var hyphen = (function () {
   var url = (document.location.href.substr(0,5) == "file:") ? "localhost" : "stonkbot.xyz";
   DB (`Connecting to websocket "${url}"...`);

   var server = new WebSocket( window.location.protocol=="https:" ? `wss://${url}:7189` : `ws://${url}:7190`);

   return function get (cmd, callback) {
      if (server.readyState != WebSocket.OPEN) {
         DB.post("hyphen", "Waiting for connection readyState == OPEN...");
         if (server.readyState == WebSocket.CLOSED) {
           server = new WebSocket( window.location.protocol=="https:" ? `wss://${url}:7189` : `ws://${url}:7190`);
         }
         setTimeout(get.bind(0, cmd, callback), 1000);
      } else {
         server.onmessage = function (e) {
           if (typeof(e.data) == "string") {
             callback(e.data);
           } else {
              DB("hyphen binary message ignored [" + e.data + "]");
             callback("error")
           }
         }
         DB("hyphen requesting [" + cmd + "] => " + server.send(cmd));
      }
   }
})();

////////////////////////////////////////

hyphen("yolo", msg => {
  let m = JSON.parse(msg);
  document.getElementById("yololians").innerHTML =
    Object
      .keys(m)
      .sort( (a,b) => m[b]-m[a] )
      .map( k => `<b>${k}</b> ${m[k]}` )
      .join("\n");
    // Try to login with stored credentials
    if (Cookies.get("username") && Cookies.get("uuid")) {
        wslogin(Cookies.get("username"), Cookies.get("uuid"));
    }
});

function stats () {
    hyphen("stats", msg => {
        let m = JSON.parse(msg);
        document.getElementById("username").innerHTML = m.name;
        document.getElementById("stats").innerHTML =
            Object
            .keys(m)
            .sort( (a,b) => m[b]-m[a] )
            .map( k => `<b>${k}</b> ${m[k]}` )
            .join("\n");
        });
}

////////////////////////////////////////

var Cookies = new Map(document.cookie.split(";").map( p => p.split("=").map( s => s.trim() ) ))
//var Cookies = new Map([["username",""],["uuid",""]]);

if (document.location.href.substr(0,5) != "file:") { ElementById('DB').style.display="none" }
if (Cookies.get("username")) { ElementById('cookies').style.display = "none"; }

////////////////////////////////////////

function wslogin (username, code) {
  let E = document.getElementById("login");
  E.value = "";
  E.placeholder = "verifying";
  hyphen(`login ${username} ${code}`, msg => {
      if (msg=="") {
          E.placeholder = "login";
          E.value = "";
      } else {
          document.cookie=`username=${username}`
          document.cookie=`uuid=${code}`
          E.placeholder = `welcome ${msg}`;
          ElementById('cookies').style.display = "none";
          stats();
      }
  });
}

var Username = "";
function login (event) {
  if (event.code != "Enter") { return; }
  let state = event.target.placeholder;
  if (state == "login") {
     let E = document.getElementById("login");
      Username = event.target.value;
      hyphen(`login ${Username}`, msg => {
          E.value = "";
          E.placeholder = "code";
      });
  } else if (state == "code") {
      wslogin(Username, event.target.value)
  }

  DB("Username="+Username)
}

// Fake stonk graph animation
let canvas = document.getElementsByTagName('canvas')[0];
let ctx = canvas.getContext('2d');
let [width,height] = [canvas.width, canvas.height];
let me = new Array(width+1).fill(0);
me.stroke = (s)=>((ctx.strokeStyle=s), ctx.stroke(), me);
me.begin = ()=>(ctx.beginPath(), me);
me.line = function (a,b,x,y) {
  let [m,n] = (a<x)?[-.5,.5]:[.5,-.5];
  let [o,p] = (b<y)?[0,0]:[0,0];
  ctx.moveTo(a,b+o); ctx.lineTo(x,y+p); return me;
}
me.rect = (s,a,b,w,h)=>((ctx.fillStyle=s),ctx.fillRect( Floor(a)-1, Floor(b)-1, w, h), me);
ctx.setTransform(1, 0, 0, -1, 0, height/2);
+function forever (price, idx) {
  me.rect("rgb(0,0,0)", 0, -height/2+1, width, height) // Clear
  .begin().line(-.5,-.5,width,-.5).stroke("rgb(128,128,128)"); // axis
  for (let x=0; x<width; ++x) { // graph
    let [a,b] = [me[(x+idx) % me.length], me[(x+idx+1) % me.length]];
    me
    .begin().line(x-.5,Round(a),x-.5,Round(b))
    .stroke((a < b)?"rgb(0,255,0)":(b < a)?"rgb(255,0,0)":"rgb(128,128,128)");
  }
  setTimeout(forever.bind(0,
    me[idx] = (height/2 < Abs(price)) ? price*=.5 : price + Round(Rnd()*10)-5,
    (idx+1)%me.length
  ), 100);
}(0,0);

//]]>
</script></body></html>